<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Start New Chat Test</title>
</head>
<body>
    <h1>Start New Chat Test Runner</h1>
    <div id="test-results"></div>

    <script>
        // Test Runner for Smart Chat Flow UI Tests
        class TestRunner {
            constructor() {
                this.tests = [];
                this.results = [];
            }

            // Add test to the suite
            addTest(name, testFunction) {
                this.tests.push({ name, testFunction });
            }

            // Run all tests
            async runTests() {
                console.log('🧪 Starting Smart Chat Flow UI Tests...\n');
                const resultsDiv = document.getElementById('test-results');
                
                for (const test of this.tests) {
                    try {
                        console.log(`Running: ${test.name}`);
                        await test.testFunction();
                        console.log(`✅ PASS: ${test.name}\n`);
                        this.results.push({ name: test.name, status: 'PASS' });
                        resultsDiv.innerHTML += `<div style="color: green;">✅ PASS: ${test.name}</div>`;
                    } catch (error) {
                        console.log(`❌ FAIL: ${test.name}`);
                        console.log(`   Error: ${error.message}\n`);
                        this.results.push({ name: test.name, status: 'FAIL', error: error.message });
                        resultsDiv.innerHTML += `<div style="color: red;">❌ FAIL: ${test.name}: ${error.message}</div>`;
                    }
                }
                
                this.printSummary();
            }

            // Print test summary
            printSummary() {
                console.log('📊 Test Summary:');
                console.log('================');
                
                const passed = this.results.filter(r => r.status === 'PASS').length;
                const failed = this.results.filter(r => r.status === 'FAIL').length;
                
                console.log(`✅ Passed: ${passed}`);
                console.log(`❌ Failed: ${failed}`);
                console.log(`📈 Success Rate: ${((passed / this.tests.length) * 100).toFixed(1)}%`);
                
                const resultsDiv = document.getElementById('test-results');
                resultsDiv.innerHTML += `<hr><h3>Test Summary:</h3>`;
                resultsDiv.innerHTML += `<div>✅ Passed: ${passed}</div>`;
                resultsDiv.innerHTML += `<div>❌ Failed: ${failed}</div>`;
                resultsDiv.innerHTML += `<div>📈 Success Rate: ${((passed / this.tests.length) * 100).toFixed(1)}%</div>`;
            }
        }

        // Test: Start New Chat Functionality
        function testStartNewChat() {
            return new Promise((resolve, reject) => {
                console.log('   Testing Start New Chat functionality...');
                
                // Mock the chat state
                const mockState = {
                    chatStarted: true,
                    current: 2,
                    answers: { 'employee-name': 'John Doe' },
                    viewingHistory: null,
                    serviceId: 'system-access-request'
                };
                
                // Simulate starting a new chat
                const newChatState = {
                    chatStarted: false,
                    current: 0,
                    answers: {},
                    viewingHistory: null,
                    serviceId: 'system-access-request' // Should keep the current service
                };
                
                // Test that new chat resets all state
                const stateReset = 
                    newChatState.chatStarted === false &&
                    newChatState.current === 0 &&
                    Object.keys(newChatState.answers).length === 0 &&
                    newChatState.viewingHistory === null;
                
                if (stateReset) {
                    console.log('   ✅ State reset test passed');
                } else {
                    console.log('   ❌ State reset test failed');
                    reject(new Error('State reset test failed'));
                    return;
                }
                
                // Test service remains the same
                if (newChatState.serviceId === 'system-access-request') {
                    console.log('   ✅ Service remains the same test passed');
                } else {
                    console.log('   ❌ Service remains the same test failed');
                    reject(new Error('Service remains the same test failed'));
                    return;
                }
                
                console.log('   ✅ Start New Chat functionality test passed');
                resolve();
            });
        }

        // Test: Start New Chat from Different Services
        function testStartNewChatFromDifferentServices() {
            return new Promise((resolve, reject) => {
                console.log('   Testing Start New Chat from different services...');
                
                const services = [
                    'system-access-request',
                    'feature-request',
                    'employee-onboarding'
                ];
                
                let allPassed = true;
                
                services.forEach(serviceId => {
                    // Mock starting from each service
                    const mockState = {
                        serviceId,
                        chatStarted: true,
                        current: 1,
                        answers: { 'test': 'data' }
                    };
                    
                    // Simulate new chat
                    const newChatState = {
                        serviceId: serviceId, // Should keep the current service
                        chatStarted: false,
                        current: 0,
                        answers: {}
                    };
                    
                    if (newChatState.serviceId !== serviceId) {
                        allPassed = false;
                        console.log(`   ❌ Service ${serviceId} should remain the same`);
                    }
                });
                
                if (allPassed) {
                    console.log('   ✅ Start New Chat from different services test passed');
                    resolve();
                } else {
                    reject(new Error('Start New Chat from different services test failed'));
                }
            });
        }

        // Test: LocalStorage Clearing
        function testLocalStorageClearing() {
            return new Promise((resolve, reject) => {
                console.log('   Testing localStorage clearing on new chat...');
                
                // Mock localStorage data
                const mockUserEmail = 'test@example.com';
                const mockCurrentChat = {
                    serviceId: 'system-access-request',
                    current: 2,
                    answers: { 'employee-name': 'John Doe' },
                    chatStarted: true
                };
                
                // Simulate localStorage
                localStorage.setItem(`chat-current-${mockUserEmail}`, JSON.stringify(mockCurrentChat));
                
                // Simulate starting new chat (should clear current chat data)
                const shouldClearCurrentChat = true;
                
                if (shouldClearCurrentChat) {
                    console.log('   ✅ LocalStorage clearing test passed');
                    resolve();
                } else {
                    reject(new Error('LocalStorage clearing test failed'));
                }
            });
        }

        // Test: New Chat Button Visibility
        function testNewChatButtonVisibility() {
            return new Promise((resolve, reject) => {
                console.log('   Testing New Chat button visibility...');
                
                // Test different chat states
                const testCases = [
                    { chatStarted: true, showSummary: false, chatCancelled: false, shouldShow: true },
                    { chatStarted: false, showSummary: false, chatCancelled: false, shouldShow: false },
                    { chatStarted: true, showSummary: true, chatCancelled: false, shouldShow: false },
                    { chatStarted: true, showSummary: false, chatCancelled: true, shouldShow: false }
                ];
                
                let allPassed = true;
                
                testCases.forEach((testCase, index) => {
                    const shouldShow = testCase.chatStarted && !testCase.showSummary && !testCase.chatCancelled;
                    
                    if (shouldShow !== testCase.shouldShow) {
                        allPassed = false;
                        console.log(`   ❌ Test case ${index + 1} failed: expected ${testCase.shouldShow}, got ${shouldShow}`);
                    }
                });
                
                if (allPassed) {
                    console.log('   ✅ New Chat button visibility test passed');
                    resolve();
                } else {
                    reject(new Error('New Chat button visibility test failed'));
                }
            });
        }

        // Test: Chat History Preservation
        function testChatHistoryPreservation() {
            return new Promise((resolve, reject) => {
                console.log('   Testing chat history preservation...');
                
                // Mock chat history
                const mockHistory = [
                    {
                        id: '1',
                        serviceId: 'system-access-request',
                        serviceTitle: 'System Access Request',
                        answers: { 'employee-name': 'John Doe' },
                        timestamp: new Date()
                    }
                ];
                
                // Simulate starting new chat (should preserve history but clear current state)
                const historyPreserved = mockHistory.length > 0;
                const currentStateCleared = true; // Current state should be cleared
                
                if (historyPreserved && currentStateCleared) {
                    console.log('   ✅ Chat history preservation test passed');
                    resolve();
                } else {
                    reject(new Error('Chat history preservation test failed'));
                }
            });
        }

        // Initialize and run tests
        const runner = new TestRunner();
        
        runner.addTest('Start New Chat Functionality', testStartNewChat);
        runner.addTest('Start New Chat from Different Services', testStartNewChatFromDifferentServices);
        runner.addTest('LocalStorage Clearing', testLocalStorageClearing);
        runner.addTest('New Chat Button Visibility', testNewChatButtonVisibility);
        runner.addTest('Chat History Preservation', testChatHistoryPreservation);
        
        // Run tests when page loads
        window.addEventListener('load', () => {
            setTimeout(() => {
                runner.runTests();
            }, 1000);
        });
    </script>
</body>
</html> 